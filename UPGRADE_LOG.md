# FlexRadio 6400 Control - Upgrade Log

## 升级日期
2025-02-11

## 已执行的升级

### 1. flexradio_gui.py
- **升级 1.1**: `on_rf_gain_changed` 函数添加 `self.update_status()` 调用
  - 位置：第269行
  - 目的：当 RF 增益滑块调整后，更新状态标签

- **升级 1.2**: `on_af_gain_changed` 函数添加 `self.update_status()` 调用
  - 位置：第277行
  - 目的：当 AF 增益滑块调整后，更新状态标签

### 2. run.py
- **升级 2.1**: 改进异步事件循环处理
  - 从 `loop.run_forever()` 改为 `loop.run_until_complete(asyncio.sleep(0.01))`
  - 添加任务取消机制：`asyncio.all_tasks(loop)`
  - 更好的关闭处理

### 3. audio_manager.py
- **升级 3.1**: `_rx_stream_callback` 添加异常处理
  - 添加 try-except 块
  - 记录回调错误到日志

- **升级 3.2**: `_tx_stream_callback` 添加异常处理
  - 添加 try-except 块
  - 记录回调错误到日志

### 4. flexradio_client.py
- **升级 4.1**: 添加可配置的超时参数
  - `__init__` 添加 `timeout` 参数（默认 5.0 秒）
  - 使用 `self.timeout` 而不是硬编码的 5.0

### 5. flexradio_gui.py - UI 优化（2025-02-11 第二轮）

#### 5.1 频段快捷按钮
- **添加**：9 个频段快捷按钮（160m-10m）
  - 位置：第129-145行
  - 功能：点击按钮快速切换到标准频段
  - 包含频段名称、频率、边带模式

#### 5.2 增益滑块数值显示
- **添加**：RF Power 和 AF Gain 数值标签
  - 位置：第168、177行
  - 功能：实时显示当前增益百分比（如 "50%"）

#### 5.3 PTT 状态颜色指示
- **添加**：TX 按钮红色背景，RX 按钮绿色背景
  - 位置：第158-162行
  - 功能：视觉反馈 PTT 状态

#### 5.4 状态栏
- **添加**：QStatusBar 状态栏
  - 位置：第109-110行
  - 功能：显示连接状态、错误消息、操作提示

#### 5.5 连接状态指示
- **升级**：连接操作添加状态栏消息
  - 位置：第241-284行
  - 功能：显示"Connecting..."、"Connected"、"Disconnected"等状态

#### 5.6 友好的错误对话框
- **添加**：连接失败时显示详细错误消息
  - 位置：第264-278行
  - 功能：提供故障排查建议

#### 5.7 窗口几何记忆
- **添加**：保存和恢复窗口位置、大小
  - 位置：第114、449-467行
  - 功能：启动时恢复上次的窗口布局

#### 5.8 新增方法
- `_update_band_buttons()`: 更新频段按钮启用状态
- `on_band_select(index)`: 处理频段按钮点击
- `_load_window_geometry()`: 加载窗口几何
- `_save_window_geometry()`: 保存窗口几何

## 验证结果

✅ 所有 Python 文件语法检查通过
✅ RF/AF 增益滑块更新已添加
✅ 音频回调异常处理已添加
✅ 异步事件循环处理已改进
✅ 可配置超时已实现
✅ 频段快捷按钮已添加
✅ 增益数值显示已添加
✅ PTT 状态颜色指示已添加
✅ 状态栏已添加
✅ 连接状态指示已改进
✅ 友好的错误对话框已添加
✅ 窗口几何记忆已实现

## 代码质量改进

1. **更好的错误处理**：添加了 try-except 块到关键回调函数
2. **状态同步**：UI 状态标签现在在所有控制操作后更新
3. **资源管理**：改进了异步任务清理和关闭处理
4. **可配置性**：网络超时现在可通过构造函数参数配置
5. **用户体验**：添加频段快捷、数值显示、状态指示、错误提示
